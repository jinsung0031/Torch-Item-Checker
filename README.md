# Torch Item Checker

Torch Item Checker는 토치에서 파밍한 아이템의 가치를 시간 대비로 계산하는
데스크톱/터미널 도구입니다. 전체 세션과 맵 단위의 타이머/수익을 동시에
관리할 수 있도록 설계되었고, FastAPI 기반의 경량 서버를 제공해 다른
플레이어들과 드랍 가치를 공유하고 평균값을 즉시 조회할 수 있습니다.

## 요구 사항

* Python 3.9 이상

## 그래픽 인터페이스 사용 방법

터미널 대신 하나의 창에서 모든 정보를 보고 싶다면 Tkinter 기반 GUI를
실행하세요. 커뮤니티에서 공유한 시세를 함께 조회할 수 있도록
`server.py`의 FastAPI 인스턴스와 연동하는 검색 패널도 포함되어 있습니다.

```bash
python gui_app.py
```

### 주요 화면 구성

* **전체 세션/현재 맵 패널** – 전체/맵 타이머, 누적 가치, 분당 가치를 실시간으로 표시합니다.
* **맵 제어** – 맵 이름과 시작 비용을 입력 후 `맵 시작` 버튼으로 세션을 초기화합니다. 비용은 자동으로 음수로 반영됩니다.
* **아이템 기록** – 드랍된 아이템의 설명/가치/수량을 입력하고 `기록 추가`를 누르면 맵과 전체 가치에 합산됩니다.
* **드랍 로그/맵 히스토리** – 최근 기록과 완료한 맵의 요약을 표 형태로 제공합니다.
* **커뮤니티 시세 검색** – FastAPI 서버 주소를 지정하고 아이템을 검색하면 `/items` 엔드포인트의 결과를 한눈에 확인할 수 있습니다.

FastAPI 서버를 동시에 띄우고 있다면 기본 주소(`http://localhost:8000`)가
자동으로 사용되며, 필요 시 상단 입력란에서 주소를 변경할 수 있습니다.

## 터미널 사용 방법

```bash
python torch_item_checker.py
```

프로그램을 실행하면 전체 세션 타이머가 자동으로 시작됩니다. 주요 명령은
다음과 같습니다.

| 명령 | 설명 |
| --- | --- |
| `status` | 전체/맵 타이머, 누적 가치, 최근 드랍 로그, 분당 가치를 출력합니다. |
| `enter [맵이름] [소모비용]` | 새로운 맵을 시작합니다. 비용을 입력하면 맵/전체 가치에 음수로 반영되고 "시작 비용" 로그가 남습니다. |
| `add <가치> [아이템_설명] [수량]` | 드랍 아이템 가치를 기록합니다. 수량을 지정하면 `가치 * 수량`이 더해지며 세부 로그가 저장됩니다. |
| `exit` | 현재 맵을 종료하고 요약/로그를 표시하며 기록에 저장합니다. |
| `history [개수]` | 종료한 맵들의 요약(시작 시각, 진행 시간, 분당 가치 등)을 최근 순으로 보여줍니다. |
| `filter <분> [맵이름|전체]` | 최근 N분 동안 특정 맵 또는 전체 세션에서 드랍된 아이템 가치를 합산해 보여줍니다. |
| `export [파일이름]` | 누적된 맵 기록을 CSV로 내보냅니다. 기본 파일명은 `tli_tracker_export.csv`입니다. |
| `reset` | 전체 세션과 모든 누적 값을 초기화합니다. |
| `quit` | 프로그램을 종료합니다. |

맵에 입장할 때 `enter` 명령으로 초기화를 수행하고, 맵이 끝나면 `exit`으로
정리하면 `status`에서 전체/맵에 대한 분당 수익을 즉시 확인할 수 있습니다.

## CSV 내보내기

`export` 명령으로 생성되는 CSV에는 시작 시각(ISO8601), 맵 진행 시간(초), 총 가치,
분당 가치, 기록된 아이템 수가 포함됩니다. 스프레드시트 프로그램에서 불러와
시간대별/맵별 필터링, 추가 분석을 이어서 진행할 수 있습니다.

## FastAPI 서버 (아이템 가치 공유)

커뮤니티에서 입력한 드랍 가치를 모아 평균, 최소/최대값 등을 확인하려면
FastAPI 서버를 실행하세요. Python 3.9 이상에서 다음 패키지가 필요합니다.

```bash
pip install "fastapi>=0.110" "uvicorn[standard]>=0.29"
```

설치가 끝나면 프로젝트 루트에서 아래 명령으로 서버를 가동합니다.

```bash
uvicorn server:app --reload
```

서버는 기본적으로 `http://127.0.0.1:8000`에서 동작하며 자동 문서(`/docs`)와
대시보드(`/`)를 제공합니다. 대시보드는 커뮤니티에서 제출된 아이템 가치를
표 형식으로 정리해 한 화면에서 확인할 수 있으며, 30초마다 자동으로
새로고침됩니다. 핵심 엔드포인트는 다음과 같습니다.

| 메서드/경로 | 설명 |
| --- | --- |
| `POST /items` | 아이템 이름, 가치, 화폐, 수량(옵션)을 제출해 커뮤니티 데이터에 합산합니다. |
| `GET /items/{item_name}` | 특정 아이템의 화폐별 집계(제출 횟수, 총합, 평균, 최소/최대)를 조회합니다. |
| `GET /items/{item_name}/entries` | 최신 제출 이력을 확인합니다. |
| `GET /items?query=검색어` | 부분 일치로 등록된 아이템을 찾습니다. |

예시 요청은 다음과 같습니다.

```bash
# 1. 드랍 가치를 제출
curl -X POST "http://127.0.0.1:8000/items" \
  -H "Content-Type: application/json" \
  -d '{"item_name":"Divine Orb","value":180,"currency":"chaos","map_name":"Atoll"}'

# 2. 누적된 통계 조회
curl "http://127.0.0.1:8000/items/Divine%20Orb"
```

현재 구현은 메모리에 데이터를 보관하므로 서버가 재시작되면 초기화됩니다.
Redis, PostgreSQL 등 지속형 저장소를 붙이고 싶다면
`server.py`의 `ItemValueAggregator`를 교체하면 됩니다.
